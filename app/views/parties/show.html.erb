<div class="dashboard">
  <%= render "shared/navbar" %>
  <div class="dashboard-body">
    <%= render "shared/sidebar", current_tab: "parties" %>
    <main class="dashboard-main">
      <div class="dashboard-card">
        <div class="page-header">
          <h1 class="page-title"><%= @party.party_name %></h1>
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <%= link_to "Edit", edit_party_path(@party), class: "btn-primary" %>
            <%= link_to "Back to Parties", root_path(tab: "parties"), class: "btn-secondary" %>
            <%= link_to "Delete", party_path(@party), data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this party? This will also delete all related orders and payments." }, class: "btn-danger" %>
          </div>
        </div>
        <div class="show-card">
          <div class="show-row">
            <span class="show-label">Party name</span>
            <span class="show-value"><%= @party.party_name %></span>
          </div>
          <div class="show-row">
            <span class="show-label">Phone</span>
            <span class="show-value"><%= @party.phone.presence || "—" %></span>
          </div>
          <div class="show-row">
            <span class="show-label">Address</span>
            <span class="show-value"><%= @party.address.presence || "—" %></span>
          </div>
          <div class="show-row">
            <span class="show-label">Status</span>
            <span class="show-value"><%= tag.span(@party.status.presence || "—", class: "status-pill #{@party.status&.downcase == "active" ? "active" : "inactive"}") %></span>
          </div>
          <div class="show-row">
            <span class="show-label">Account balance</span>
            <span class="show-value balance-amount balance-amount--<%= @party.balance > 0 ? 'due' : (@party.balance < 0 ? 'credit' : 'zero') %>">
              <% if @party.balance > 0 %>
                −<%= number_to_currency(@party.balance) %> <span class="balance-label">(amount due)</span>
              <% elsif @party.balance < 0 %>
                +<%= number_to_currency(-@party.balance) %> <span class="balance-label">(advance / credit)</span>
              <% else %>
                <%= number_to_currency(0) %>
              <% end %>
            </span>
          </div>
        </div>

        <section class="party-history">
          <h2 class="party-history__title">Orders</h2>
          <% if @party.orders.any? %>
            <div class="table-wrap">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Order</th>
                    <th>Date</th>
                    <th>Total</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @party.orders.order(created_at: :desc).limit(20).each do |order| %>
                    <tr>
                      <td><%= order.display_number %></td>
                      <td><%= order.order_date&.strftime("%b %d, %Y") || order.created_at.strftime("%b %d, %Y") %></td>
                      <td><%= number_to_currency(order.total_amount) %></td>
                      <td><%= link_to "View", order_path(order), class: "btn-link" %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            <% if @party.orders.count > 20 %>
              <p class="party-history__more"><%= @party.orders.count - 20 %> more orders</p>
            <% end %>
          <% else %>
            <p class="party-history__empty">No orders yet.</p>
          <% end %>
        </section>

        <section class="party-history">
          <h2 class="party-history__title">Payments</h2>
          <% if @party.payments.any? %>
            <div class="table-wrap">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Order</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @party.payments.order(payment_date: :desc, created_at: :desc).limit(20).each do |payment| %>
                    <tr>
                      <td><%= payment.payment_date&.strftime("%b %d, %Y") %></td>
                      <td><%= number_to_currency(payment.amount) %></td>
                      <td><%= payment.order_id.present? ? link_to(payment.order.display_number, order_path(payment.order)) : "—" %></td>
                      <td><%= link_to "View", payment_path(payment), class: "btn-link" %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            <% if @party.payments.count > 20 %>
              <p class="party-history__more"><%= @party.payments.count - 20 %> more payments</p>
            <% end %>
          <% else %>
            <p class="party-history__empty">No payments yet.</p>
          <% end %>
        </section>
      </div>
    </main>
  </div>
</div>
