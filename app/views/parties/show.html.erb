<div class="dashboard">
  <%= render "shared/navbar" %>
  <div class="dashboard-body">
    <%= render "shared/sidebar", current_tab: "parties" %>
    <main class="dashboard-main">
      <div class="dashboard-card">
        <div class="page-header">
          <h1 class="page-title"><%= @party.party_name %></h1>
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <a href="#party_history" class="btn-secondary btn-secondary--light">
              <span class="btn-history-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 6v6l4 2"></path>
                </svg>
              </span>
              History
            </a>
            <%= link_to "Edit", edit_party_path(@party), class: "btn-primary" %>
            <%= link_to "Back to Parties", root_path(tab: "parties"), class: "btn-secondary" %>
            <%= link_to "Delete", party_path(@party), data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this party? This will also delete all related orders and payments." }, class: "btn-danger" %>
          </div>
        </div>
        <div class="show-card">
          <div class="show-row">
            <span class="show-label">Party name</span>
            <span class="show-value"><%= @party.party_name %></span>
          </div>
          <div class="show-row">
            <span class="show-label">Phone</span>
            <span class="show-value"><%= @party.phone.presence || "—" %></span>
          </div>
          <div class="show-row">
            <span class="show-label">Address</span>
            <span class="show-value"><%= @party.address.presence || "—" %></span>
          </div>
          <div class="show-row">
            <span class="show-label">Status</span>
            <span class="show-value"><%= tag.span(@party.status.presence || "—", class: "status-pill #{@party.status&.downcase == "active" ? "active" : "inactive"}") %></span>
          </div>
          <div class="show-row">
            <span class="show-label">Account balance</span>
            <span class="show-value balance-amount balance-amount--<%= @party.balance > 0 ? 'due' : (@party.balance < 0 ? 'credit' : 'zero') %>">
              <% if @party.balance > 0 %>
                −<%= number_to_currency(@party.balance) %> <span class="balance-label">(amount due)</span>
              <% elsif @party.balance < 0 %>
                +<%= number_to_currency(-@party.balance) %> <span class="balance-label">(advance / credit)</span>
              <% else %>
                <%= number_to_currency(0) %>
              <% end %>
            </span>
          </div>
        </div>

        <section class="party-history party-history--combined" id="party_history">
          <h2 class="party-history__title">History</h2>
          <% if @history_items.blank? %>
            <p class="party-history__empty">No orders or payments yet.</p>
          <% else %>
            <div class="dash-table-wrap party-history-table-wrap">
              <table class="dash-table party-history-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Balance after</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @history_items.each do |item| %>
                    <tr>
                      <td><%= item[:date].strftime("%b %d, %Y") %></td>
                      <td><%= item[:kind] %></td>
                      <td><%= item[:description] %></td>
                      <td class="text-mono">
                        <% if item[:kind] == "Payment" || (item[:kind] == "Opening" && item[:delta].negative?) %>
                          +<%= number_to_currency(item[:amount]) %>
                        <% else %>
                          −<%= number_to_currency(item[:amount]) %>
                        <% end %>
                      </td>
                      <td class="text-mono">
                        <% balance = item[:balance] %>
                        <% if balance > 0 %>
                          −<%= number_to_currency(balance) %>
                        <% elsif balance < 0 %>
                          +<%= number_to_currency(-balance) %>
                        <% else %>
                          <%= number_to_currency(0) %>
                        <% end %>
                      </td>
                      <td>
                        <% if item[:record].is_a?(Order) %>
                          <%= link_to "View order", order_path(item[:record]), class: "btn-link" %>
                        <% elsif item[:record].is_a?(Payment) %>
                          <%= link_to "View payment", payment_path(item[:record]), class: "btn-link" %>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% end %>
        </section>
      </div>
    </main>
  </div>
</div>
